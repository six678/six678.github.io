<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>158930.Com-æ•°æ®åˆ†æä¸­å¿ƒ</title>
  <!-- å¼•å…¥ Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary-color: #4361ee;
      --success-color: #4cc9f0;
      --error-color: #f72585;
      --bg-color: #f8f9fa;
      --sidebar-bg: #1e1e2d;
      --card-bg: #ffffff;
      --text-main: #2c3e50;
      --text-dim: #7f8c8d;
    }

    body {
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* ç§»åŠ¨ç«¯èœå•æŒ‰é’® */
    .mobile-menu-btn {
      display: none;
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--primary-color);
      color: white;
      justify-content: center;
      align-items: center;
      box-shadow: 0 4px 12px rgba(67, 97, 238, 0.4);
      z-index: 2000;
      border: none;
      cursor: pointer;
      font-size: 24px;
    }

    /* ä¾§è¾¹æ æ ·å¼ */
    .sidebar {
      width: 320px;
      background-color: var(--sidebar-bg);
      color: #fff;
      padding: 24px;
      display: flex;
      flex-direction: column;
      box-shadow: 4px 0 10px rgba(0, 0, 0, 0.1);
      overflow-y: auto;
    }

    .sidebar h2 {
      font-size: 20px;
      margin-bottom: 30px;
      color: #4cc9f0;
      text-align: center;
      letter-spacing: 1px;
    }

    .param-group {
      margin-bottom: 20px;
    }

    .param-group label {
      display: block;
      font-size: 13px;
      color: #a2a2c2;
      margin-bottom: 8px;
    }

    .sidebar input[type="number"],
    .sidebar input[type="date"],
    .sidebar select {
      width: 100%;
      background: #2b2b40;
      border: 1px solid #3f3f5f;
      padding: 10px;
      border-radius: 6px;
      color: #fff;
      box-sizing: border-box;
      outline: none;
    }

    .sidebar input:focus {
      border-color: var(--primary-color);
    }

    .sidebar .btn-analyze {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 14px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 20px;
      transition: all 0.3s;
    }

    .sidebar .btn-analyze:hover {
      background-color: #3046bc;
      transform: translateY(-2px);
    }

    /* ä¸»ä½“å†…å®¹åŒºåŸŸ */
    .main-content {
      flex: 1;
      padding: 30px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    /* ç»Ÿè®¡å¡ç‰‡ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
    }

    .stat-card {
      background: var(--card-bg);
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      text-align: center;
    }

    .stat-card .value {
      font-size: 24px;
      font-weight: 800;
      margin-bottom: 8px;
    }

    .stat-card .label {
      font-size: 14px;
      color: var(--text-dim);
    }

    /* å›¾è¡¨å®¹å™¨ */
    .chart-section {
      background: var(--card-bg);
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      height: 300px;
    }

    /* è¡¨æ ¼åŒºåŸŸ */
    .table-section {
      background: var(--card-bg);
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      flex: 1;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background-color: #f8f9fc;
      text-align: left;
      padding: 12px;
      font-size: 13px;
      color: var(--text-dim);
      border-bottom: 2px solid #edeff5;
    }

    td {
      padding: 12px;
      border-bottom: 1px solid #f1f3f9;
      font-size: 14px;
    }

    .hit {
      color: #27ae60;
      font-weight: bold;
    }

    .miss {
      color: #e74c3c;
      font-weight: bold;
    }

    /* æœ€ä¼˜ç­–ç•¥åˆ—è¡¨æ ·å¼ */
    .strategy-list {
      margin-top: 20px;
      border-top: 1px solid #3f3f5f;
      padding-top: 20px;
    }

    .strategy-list h3 {
      font-size: 14px;
      color: #4cc9f0;
      margin-bottom: 12px;
    }

    .strategy-item {
      background: #2b2b40;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
    }

    .strategy-item:hover {
      border-color: var(--primary-color);
      background: #343452;
    }

    .strategy-item.active {
      border-color: var(--primary-color);
      background: var(--primary-color);
    }

    .strategy-item .profit {
      font-weight: bold;
      color: #27ae60;
      font-size: 13px;
    }

    .strategy-item .meta {
      font-size: 11px;
      color: #a2a2c2;
      margin-top: 4px;
    }

    .loading-mask {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      display: none;
    }

    /* å“åº”å¼åª’ä½“æŸ¥è¯¢ */
    @media (max-width: 850px) {
      body {
        flex-direction: column;
        height: auto;
        overflow: auto;
      }

      .sidebar {
        width: 100%;
        height: auto;
        padding: 20px;
        box-shadow: none;
        box-sizing: border-box;
      }

      .sidebar.collapsed {
        display: none;
      }

      .mobile-menu-btn {
        display: flex;
      }

      .main-content {
        padding: 15px;
        overflow: visible;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }

      .stat-card {
        padding: 15px;
      }

      .stat-card .value {
        font-size: 18px;
      }

      .chart-section {
        height: 250px;
        padding: 15px;
      }

      .table-section {
        padding: 15px;
      }

      .table-wrapper {
        overflow-x: auto;
      }

      table {
        min-width: 600px;
      }

      th,
      td {
        padding: 8px;
        font-size: 13px;
      }
    }

    @media (max-width: 480px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }

    /* å¼€å¥–è®°å½•æµ®çª—æŒ‰é’®æ ·å¼å¯é€‰ï¼Œç›®å‰ç›´æ¥æ”¾åœ¨ Tab é‡Œæˆ–ç‹¬ç«‹æˆå— */
  </style>
</head>

<body>

  <button class="mobile-menu-btn" onclick="toggleSidebar()">âš™ï¸</button>

  <div class="sidebar" id="sidebar">
    <h2>ğŸ“Š åˆ†æä¸­å¿ƒ</h2>

    <div class="param-group">
      <label>èµ·å§‹æ—¥æœŸ</label>
      <input type="date" id="startDate" value="2026-01-01">
    </div>

    <div class="param-group">
      <label>ç»“æŸæ—¥æœŸ</label>
      <input type="date" id="endDate">
    </div>

    <div class="param-group">
      <label>èµ·å§‹åç§»å¤©æ•°</label>
      <input type="number" id="startOffsetDays" value="1">
    </div>

    <div class="param-group">
      <label>å‚è€ƒåç§»å¤©æ•°</label>
      <input type="number" id="referOffsetDays" value="30">
    </div>

    <div class="param-group">
      <label>æ’é™¤å¤©æ•°</label>
      <input type="number" id="excludingDays" value="30">
    </div>

    <div class="param-group">
      <label>æ’é™¤åç§»å¤©æ•°</label>
      <input type="number" id="excludingOffsetDays" value="1">
    </div>

    <div class="param-group">
      <label>åˆ†æå·ç ä½ç½®</label>
      <select id="targetPos" onchange="renderStrategies()">
        <option value="0">å¹³ç  1</option>
        <option value="1">å¹³ç  2</option>
        <option value="2">å¹³ç  3</option>
        <option value="3">å¹³ç  4</option>
        <option value="4">å¹³ç  5</option>
        <option value="5">å¹³ç  6</option>
        <option value="6" selected>ç‰¹ç  (ç¬¬7ä½)</option>
      </select>
    </div>

    <div class="param-group">
      <label>å•æŸ±æŠ•å…¥ (å…ƒ)</label>
      <input type="number" id="amountPerItem" value="50">
    </div>

    <div class="param-group">
      <label>
        <input type="checkbox" id="isReverse"> å–åé€»è¾‘
      </label>
    </div>

    <button class="btn-analyze" onclick="runAnalysis()">å¼€å§‹å…¨é¢åˆ†æ</button>

    <div class="strategy-list" id="bestStrategyList">
      <h3>ğŸ† æœ€ä¼˜ç­–ç•¥æ¨è (Top 8)</h3>
      <div id="strategyContainer">
        <p style="font-size: 12px; color: #777;">æ­£åœ¨è®¡ç®—æœ€ä¼˜ç»„åˆ...</p>
      </div>
    </div>

    <div style="margin-top: auto; font-size: 12px; color: #555; text-align: center;">
      <p>æ•°æ®æº: data.json</p>
      <p id="dataCount">æ­£åœ¨åŠ è½½æ•°æ®...</p>
    </div>
  </div>

  <div class="main-content">
    <!-- ä¸‹æœŸé¢„æµ‹ -->
    <div id="nextRoundCard" class="stat-card"
      style="grid-column: span 1; background: linear-gradient(135deg, #4361ee, #4cc9f0); color: white; text-align: left; padding: 24px; display:none; margin-bottom: 0;">
      <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
        <span>ğŸ”® ä¸‹ä¸€æœŸæŠ•æ³¨å»ºè®®</span>
      </div>
      <div id="nextPredictionNums"
        style="font-size: 18px; font-weight: bold; letter-spacing: 0.5px; line-height: 1.4; word-break: break-all;">
        æ­£åœ¨è®¡ç®—...
      </div>
      <div id="nextPredictionInfo"
        style="font-size: 11px; margin-top: 12px; opacity: 0.8; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 8px;">
        åŸºäºæœ€æ–°å¼€å¥–æ•°æ®å®æ—¶åˆ†æ
      </div>
    </div>

    <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="value" id="statProfit">--</div>
        <div class="label">æ€»ç›ˆåˆ© (å…ƒ)</div>
      </div>
      <div class="stat-card">
        <div class="value" id="statHitRate">--</div>
        <div class="label">å¹³å‡å‘½ä¸­ç‡</div>
      </div>
      <div class="stat-card">
        <div class="value" id="statHitCount">--</div>
        <div class="label">å‘½ä¸­/æ€»æœŸæ•°</div>
      </div>
      <div class="stat-card">
        <div class="value" id="statAvgNums">--</div>
        <div class="label">å¹³å‡æŠ•æ³¨æ•°</div>
      </div>
    </div>

    <!-- å¢é•¿è¶‹åŠ¿å›¾ -->
    <div class="chart-section">
      <canvas id="profitChart"></canvas>
    </div>

    <!-- è¯¦æƒ…è¡¨æ ¼ -->
    <div class="table-section">
      <h3 style="margin-top: 0;">åˆ†æè¯¦æƒ…</h3>
      <div class="table-wrapper" style="overflow-y: auto; max-height: 400px;">
        <table id="detailsTable">
          <thead>
            <tr>
              <th>æ—¥æœŸ</th>
              <th>ä¸­å¥–å·</th>
              <th>æŠ•æ³¨æ•°</th>
              <th>ç»“æœ</th>
              <th>ç›ˆåˆ©</th>
              <th>ç´¯è®¡ç›ˆäº</th>
              <th>è¯¦æƒ…</th>
            </tr>
          </thead>
          <tbody id="detailsBody">
            <tr>
              <td colspan="7" style="text-align:center; color:#999;">è¯·å…ˆç‚¹å‡»å¼€å§‹åˆ†æ</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="loading" class="loading-mask">ğŸ”¥ æ­£åœ¨æ·±åº¦å›æµ‹ä¸­...</div>

  <script>
    // --- æ ¸å¿ƒå¼•æ“æ•°æ®ç»“æ„ ---
    let historyArray = [];
    let dateToIndex = new Map();
    let allStrategies = []; // å…¨å±€ç¼“å­˜å¯»ä¼˜ç»“æœ
    const allNumbers = Array.from({ length: 49 }).map((_, i) => i + 1);
    let myChart = null;

    // --- åˆå§‹åŒ–: åŠ è½½æ•°æ® ---
    async function loadData() {
      try {
        const res = await fetch("data.json");
        const jsonData = await res.json();

        const tempRecords = [];
        for (const item of jsonData) {
          if (!item.openTime || !item.openCode) continue;

          // æå–æ—¥æœŸéƒ¨åˆ† (YYYY-MM-DD)
          const dStr = item.openTime.split(" ")[0];

          // è§£æå·ç 
          const nums = item.openCode.split(",").map(n => parseInt(n.trim()));

          if (nums.length >= 7 && !nums.some(isNaN)) {
            tempRecords.push({ date: dStr, nums: nums });
          }
        }

        // æŒ‰æ—¥æœŸå‡åºæ’åˆ— (æ–¹ä¾¿ä»å‰å¾€åè®¡ç®—è½¨è¿¹)
        historyArray = tempRecords.sort((a, b) => a.date.localeCompare(b.date));

        // å»ºç«‹ç´¢å¼•
        dateToIndex.clear();
        historyArray.forEach((r, i) => dateToIndex.set(r.date, i));

        document.getElementById('dataCount').textContent = `æˆåŠŸåŠ è½½ ${historyArray.length} æ¡è®°å½•`;
        document.getElementById('endDate').value = historyArray[historyArray.length - 1].date;

        // åŠ è½½å¯»ä¼˜å‚æ•°
        await loadBestParams();

        console.log("Ready.");
      } catch (e) {
        console.error(e);
        alert("åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·ç¡®ä¿ç›®å½•ä¸‹æœ‰ Amc_all.csv");
      }
    }

    // --- åŠ è½½æœ€ä¼˜å‚æ•° ---
    async function loadBestParams() {
      try {
        const res = await fetch("optimization_results.csv");
        if (!res.ok) return;

        const text = await res.text();
        const rows = text.trim().split("\n");
        if (rows.length < 2) return;

        const header = rows[0].split(",").map(h => h.trim());

        // è§£æå¹¶å­˜å‚¨æ‰€æœ‰ç­–ç•¥
        allStrategies = rows.slice(1).map(row => {
          const cols = row.split(",");
          const paramMap = {};
          header.forEach((h, i) => paramMap[h] = cols[i].trim());
          return paramMap;
        });

        console.log(`æˆåŠŸåŠ è½½ ${allStrategies.length} æ¡å¯»ä¼˜ç­–ç•¥`);
        renderStrategies(); // åˆå§‹æ¸²æŸ“

      } catch (e) {
        console.warn("æœªèƒ½åŠ è½½å¯»ä¼˜ç»“æœ:", e);
        document.getElementById('strategyContainer').innerHTML = '<p style="font-size: 12px; color: #f72585;">æ— æ³•åŠ è½½å†å²ä¼˜åŒ–æ•°æ®</p>';
      }
    }

    // æ ¹æ®å½“å‰é€‰ä¸­çš„ä½ç½®æ¸²æŸ“å‰ 8 æ¡ç­–ç•¥
    function renderStrategies() {
      const currentPos = document.getElementById('targetPos').value;
      const strategyContainer = document.getElementById('strategyContainer');
      strategyContainer.innerHTML = '';

      // è¿‡æ»¤å½“å‰ä½ç½®çš„ç­–ç•¥
      const filtered = allStrategies
        .filter(s => s.targetPos === currentPos)
        .slice(0, 8);

      if (filtered.length === 0) {
        strategyContainer.innerHTML = '<p style="font-size: 12px; color: #777;">å½“å‰ä½ç½®æš‚æ— å¯»ä¼˜ç»“æœ</p>';
        return;
      }

      filtered.forEach((paramMap, index) => {
        const div = document.createElement('div');
        div.className = 'strategy-item' + (index === 0 ? ' active' : '');
        div.onclick = () => applyParams(paramMap, div);

        div.innerHTML = `
          <div class="profit">åˆ©æ¶¦: ${parseFloat(paramMap.Profit).toLocaleString()} å…ƒ</div>
          <div class="meta">
            èƒœç‡: ${(parseFloat(paramMap.HitRate)).toFixed(1)}% | 
            sOff:${paramMap.startOffsetDays}, rOff:${paramMap.referOffsetDays}, eD:${paramMap.excludingDays}, eOff:${paramMap.excludingOffsetDays}
          </div>
        `;
        strategyContainer.appendChild(div);

        // åˆ‡æ¢ä½ç½®åçš„ç‚¹å‡»åé¦ˆå¯é€‰ï¼šæ­¤å¤„æˆ‘ä»¬ä¸é»˜è®¤è¿è¡Œï¼Œåªåº”ç”¨å‚æ•°ã€‚
        // å¦‚æœå¸Œæœ›åˆ‡æ¢ä½ç½®è‡ªåŠ¨è¿è¡Œç¬¬ä¸€æ¡ï¼Œå¯ä»¥å¼€å¯ä¸‹é¢è¿™è¡Œï¼š
        if (index === 0) applyParams(paramMap, div, false);
      });
    }

    function applyParams(params, element, autoRun = true) {
      if (!params) return;

      // åˆ‡æ¢æ ·å¼
      document.querySelectorAll('.strategy-item').forEach(el => el.classList.remove('active'));
      if (element) element.classList.add('active');

      // åº”ç”¨å€¼ï¼ˆä¸åº”ç”¨ targetPosï¼Œå› ä¸ºåˆ—è¡¨æ˜¯æ ¹æ® targetPos è¿‡æ»¤å‡ºæ¥çš„ï¼‰
      if (params.startOffsetDays) document.getElementById('startOffsetDays').value = params.startOffsetDays;
      if (params.referOffsetDays) document.getElementById('referOffsetDays').value = params.referOffsetDays;
      if (params.excludingDays) document.getElementById('excludingDays').value = params.excludingDays;
      if (params.excludingOffsetDays) document.getElementById('excludingOffsetDays').value = params.excludingOffsetDays;
      if (params.isReverse) document.getElementById('isReverse').checked = (params.isReverse.toLowerCase() === 'true');

      if (autoRun) {
        runAnalysis();
      }
    }

    // --- é«˜æ€§èƒ½åŸå­é€»è¾‘ $O(1)$ ---
    function getOffsetDate(date, offset) {
      const idx = dateToIndex.get(date);
      if (idx === undefined) return null;
      const targetIdx = idx + offset;
      if (targetIdx < 0 || targetIdx >= historyArray.length) return null;
      return historyArray[targetIdx];
    }

    // é‡æ„ä¸ºåŸºäºç´¢å¼•çš„è®¡ç®—é€»è¾‘ï¼Œæ”¯æŒé¢„æµ‹ï¼ˆtargetIdx å¯ä»¥ç­‰äº historyArray.lengthï¼‰
    function calculateFinalByIndex(targetIdx, params) {
      const { startOffset, referOffset, exclDays, exclOffset, isReverse, targetPos } = params;

      // 1. å‚è€ƒ record (ç›¸å¯¹äºç›®æ ‡æœŸæ•°)
      const referIdx = targetIdx - startOffset;
      if (referIdx < 0 || referIdx >= historyArray.length) return null;
      const referRecord = historyArray[referIdx];
      const referNum = referRecord.nums[targetPos]; // ä½¿ç”¨æŒ‡å®šä½ç½®çš„å·ç 

      // 2. æœç´¢å›æº¯ (ä»å‚è€ƒæœŸçš„åç§»ä½ç½®å¼€å§‹å¾€å›æ‰¾ç›¸åŒå·ç )
      const searchStartIdx = referIdx - referOffset;
      if (searchStartIdx < 0) return null;

      let exclReferIdx = -1;
      for (let i = searchStartIdx; i >= 0; i--) {
        if (historyArray[i].nums[targetPos] === referNum) {
          exclReferIdx = i;
          break;
        }
      }
      if (exclReferIdx === -1) return null;

      // 3. ç¡®å®šæ’é™¤åºåˆ—çš„èµ·ç‚¹
      const indexGap = exclReferIdx - targetIdx;
      const actualOffset = Math.max(-exclOffset, indexGap + 1);

      const exclStartIdx = exclReferIdx + actualOffset;
      if (exclStartIdx < 0 || exclStartIdx >= historyArray.length) return null;

      // 4. æ”¶é›†æ’é™¤æ•°å­—
      const exclSet = new Set();
      for (let i = exclStartIdx; i > Math.max(-1, exclStartIdx - exclDays); i--) {
        exclSet.add(historyArray[i].nums[targetPos]);
      }

      const sortedExcl = [...exclSet].sort((a, b) => a - b);
      if (isReverse) return sortedExcl;

      return allNumbers.filter(n => !exclSet.has(n));
    }

    function calculateFinal(currentDate, params) {
      const idx = dateToIndex.get(currentDate);
      if (idx === undefined) return null;
      return calculateFinalByIndex(idx, params);
    }

    // --- æ‰¹é‡å›æµ‹é€»è¾‘ ---
    function runAnalysis() {
      const params = {
        start: document.getElementById('startDate').value,
        end: document.getElementById('endDate').value,
        startOffset: parseInt(document.getElementById('startOffsetDays').value),
        referOffset: parseInt(document.getElementById('referOffsetDays').value),
        exclDays: parseInt(document.getElementById('excludingDays').value),
        exclOffset: parseInt(document.getElementById('excludingOffsetDays').value),
        amount: parseInt(document.getElementById('amountPerItem').value),
        isReverse: document.getElementById('isReverse').checked,
        targetPos: parseInt(document.getElementById('targetPos').value),
        hitOdds: 47
      };

      document.getElementById('loading').style.display = 'flex';

      // ä½¿ç”¨ setTimeout é¿å… UI ç¬é—´å¡é¡¿
      setTimeout(() => {
        const results = [];
        let totalProfit = 0;
        let hitCount = 0;
        let totalNums = 0;

        // ç­›é€‰èŒƒå›´
        const filtered = historyArray.filter(r => r.date >= params.start && r.date <= params.end);

        filtered.forEach(record => {
          const finalNums = calculateFinal(record.date, params);
          if (!finalNums) return;

          const currentNum = record.nums[params.targetPos];
          const isHit = finalNums.includes(currentNum);
          const profit = isHit ?
            params.amount * (params.hitOdds - finalNums.length) :
            -params.amount * finalNums.length;

          totalProfit += profit;
          if (isHit) hitCount++;
          totalNums += finalNums.length;

          results.push({
            date: record.date,
            win: currentNum,
            count: finalNums.length,
            isHit,
            profit,
            cumulative: totalProfit,
            details: finalNums.join(', ')
          });
        });

        updateUI(results, totalProfit, hitCount, totalNums / (results.length || 1));

        // --- ä¸‹æœŸé¢„æµ‹é€»è¾‘ ---
        const nextIdx = historyArray.length;
        const nextNums = calculateFinalByIndex(nextIdx, params);
        const nextCard = document.getElementById('nextRoundCard');
        if (nextNums) {
          nextCard.style.display = 'block';
          document.getElementById('nextPredictionNums').textContent = `ï¼ˆ${nextNums.length}ä¸ªï¼‰ ${nextNums.join(',  ')}`;
          const latest = historyArray[historyArray.length - 1];
          const posLabel = document.getElementById('targetPos').options[params.targetPos].text;
          document.getElementById('nextPredictionInfo').textContent = `å‚è€ƒæœ€æ–°æ•°æ®: ${latest.date} (${posLabel}: ${latest.nums[params.targetPos]})`;
        } else {
          nextCard.style.display = 'none';
        }

        document.getElementById('loading').style.display = 'none';
      }, 50);
    }

    function updateUI(results, totalProfit, hitCount, avgNums) {
      // 1. æ›´æ–°å¡ç‰‡
      const hitRate = results.length > 0 ? (hitCount / results.length * 100).toFixed(2) : 0;
      document.getElementById('statProfit').textContent = totalProfit.toLocaleString();
      document.getElementById('statProfit').style.color = totalProfit >= 0 ? '#27ae60' : '#e74c3c';
      document.getElementById('statHitRate').textContent = hitRate + '%';
      document.getElementById('statHitCount').textContent = `${hitCount}/${results.length}`;
      document.getElementById('statAvgNums').textContent = avgNums.toFixed(1);

      // 2. æ›´æ–°å›¾è¡¨
      const labels = results.map(r => r.date);
      const data = results.map(r => r.cumulative);

      if (myChart) myChart.destroy();
      const ctx = document.getElementById('profitChart').getContext('2d');
      myChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'ç´¯è®¡ç›ˆåˆ©æ›²çº¿',
            data: data,
            borderColor: '#4361ee',
            backgroundColor: 'rgba(67, 97, 238, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.1,
            pointRadius: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { display: false },
            y: { grid: { color: '#f0f0f0' } }
          }
        }
      });

      // 3. æ›´æ–°è¡¨æ ¼
      const body = document.getElementById('detailsBody');
      body.innerHTML = '';
      results.reverse().forEach(r => {
        const tr = document.createElement('tr');
        const currentNum = r.win;
        tr.innerHTML = `
                    <td>${r.date}</td>
                    <td>${currentNum}</td>
                    <td>${r.count}</td>
                    <td class="${r.isHit ? 'hit' : 'miss'}">${r.isHit ? 'å‘½ä¸­' : 'æœªä¸­'}</td>
                    <td style="color: ${r.profit >= 0 ? '#27ae60' : '#e74c3c'}">${r.profit}</td>
                    <td style="font-weight: bold; color: ${r.cumulative >= 0 ? '#27ae60' : '#e74c3c'}">${r.cumulative.toLocaleString()}</td>
                    <td style="font-size:11px; color:#777;">${r.details}</td>
                `;
        body.appendChild(tr);
      });
    }

    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('collapsed');

      // å¹³æ»‘æ»šåŠ¨å›é¡¶éƒ¨
      if (!sidebar.classList.contains('collapsed')) {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }

    // é»˜è®¤åœ¨ç§»åŠ¨ç«¯æŠ˜å ä¾§è¾¹æ 
    if (window.innerWidth <= 850) {
      document.getElementById('sidebar').classList.add('collapsed');
    }

    // å¯åŠ¨åŠ è½½
    loadData();
  </script>
</body>

</html>